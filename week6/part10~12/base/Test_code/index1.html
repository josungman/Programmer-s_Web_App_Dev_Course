<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>퍼즐</title>
<style>
    #puzzle {
        width: 400px;
        height: 400px;
        display: grid;
        margin: 20px auto;
    }
    #previewImage{
        width: 200px;
        height: 200px;
        display: flex;
        margin: 20px auto;

    }
    .piece {
        cursor: pointer;
        position: relative;
        box-sizing: border-box;
        border: 1px solid #ccc;
    }
    .piece:hover {
        transform: scale(1.05);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.4);
    }
    #controlPanel {
        width: 400px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px auto;
    }
    #sizeSelector, #swapCount , #timer,#changeImageButton {
        margin: 20px auto;
        display: block;
    }
    #swapCount, #timer{
        text-align: center;
    }
</style>
</head>
<body>

    <div id="controlPanel">
        <select id="sizeSelector">
            <option value="3" selected>3x3</option>
            <option value="4">4x4</option>
            <option value="5">5x5</option>
            <option value="6">6x6</option>
            <option value="7">7x7</option>
            <option value="8">8x8</option>
            <option value="9">9x9</option>
            <option value="10">10x10</option>
        </select>
        <button id="changeImageButton">Change Image</button>
        <div id="swapCount">Swaps: 0</div>
        <div id="timer">Time left: 10:00</div>
    </div>

<div id="puzzle"></div>
<img id="previewImage" src="">
<div id="message" style="text-align: center; margin-top: 20px;"></div>
<script>
    let imagePath = '../data/image1/originalImage.png';
    let numPiecesPerSide = 3;
    const totalWidth = 400;
    const totalHeight = 400;
    let pieceWidth = totalWidth / numPiecesPerSide;
    let pieceHeight = totalHeight / numPiecesPerSide;

    const puzzle = document.getElementById('puzzle');
    let pieces = [];
    let swapCount = 0; // 스왑 횟수를 추적하는 변수
    let timerId;
    let totalTime = 120; // 10 minutes in seconds

    document.getElementById('sizeSelector').addEventListener('change', function() {
       
        document.getElementById('message').textContent = '';
        puzzle.style.backgroundImage = ``;
       
        numPiecesPerSide = parseInt(this.value);
        swapCount = 0; // 크기 변경 시 스왑 카운터 리셋
        document.getElementById('swapCount').textContent = `Swaps: ${swapCount}`;
        initializePuzzle();
    });

    document.getElementById('changeImageButton').addEventListener('click', function() {
         document.getElementById('message').textContent = '';
         puzzle.style.backgroundImage = ``;

         document.getElementById('previewImage').src = imagePath;

         // Select a random image from the imagePath array
         const selectedImagePath = ['../data/image1/originalImage.png','../data/image2/originalImage.png','../data/image3/originalImage.png']; // Change to a new image path
         const randomIndex = Math.floor(Math.random() * selectedImagePath.length);
        imagePath = selectedImagePath[randomIndex];
        
        initializePuzzle();
    });

    function initializePuzzle() {

        // 스왑 횟수 초기화
        swapCount = 0;
        document.getElementById('swapCount').textContent = `Swaps: ${swapCount}`;

        document.getElementById('previewImage').src = imagePath;

        resetTimer();
        pieceWidth = totalWidth / numPiecesPerSide;
        pieceHeight = totalHeight / numPiecesPerSide;
        puzzle.style.gridTemplateColumns = `repeat(${numPiecesPerSide}, 1fr)`;
        puzzle.style.gridTemplateRows = `repeat(${numPiecesPerSide}, 1fr)`;
        createPieces();
        shuffleArray(pieces);
        renderPieces();
    }

    function createPieces() {
        puzzle.innerHTML = ''; // Clear existing pieces
        pieces = [];
        for (let y = 0; y < numPiecesPerSide; y++) {
            for (let x = 0; x < numPiecesPerSide; x++) {
                const index = y * numPiecesPerSide + x;
                const piece = document.createElement('div');
                piece.className = 'piece';
                piece.dataset.index = index.toString();
                piece.dataset.currentIndex = index.toString();
                piece.style.width = `${pieceWidth}px`;
                piece.style.height = `${pieceHeight}px`;
                piece.style.backgroundImage = `url('${imagePath}')`;
                piece.style.backgroundPosition = `-${x * pieceWidth}px -${y * pieceHeight}px`;
                piece.style.backgroundSize = `${totalWidth}px ${totalHeight}px`;
                pieces.push(piece);
            }
        }
    }

    function renderPieces() {
        pieces.forEach(piece => {
            puzzle.appendChild(piece);
            piece.addEventListener('click', selectPiece);
        });
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
            array[i].dataset.currentIndex = i.toString();
            array[j].dataset.currentIndex = j.toString();
        }
    }

    

    let selectedPiece = null; // 현재 선택된 조각
    function selectPiece(event) {
        const piece = event.target;
        if (!selectedPiece) {
            selectedPiece = piece;
            piece.style.border = '3px solid red';
        } else {
            swapPieces(selectedPiece, piece);
            selectedPiece.style.border = '1px solid #ccc';
            selectedPiece = null;
            checkCompletion();
        }
    }

    function swapPieces(piece1, piece2) {
        let tempIndex = piece1.dataset.currentIndex;
        piece1.dataset.currentIndex = piece2.dataset.currentIndex;
        piece2.dataset.currentIndex = tempIndex;
        
        let index1 = pieces.indexOf(piece1);
        let index2 = pieces.indexOf(piece2);
        [pieces[index1], pieces[index2]] = [pieces[index2], pieces[index1]];
        
        // 스왑 횟수 증가
        swapCount++;
        document.getElementById('swapCount').textContent = `Swaps: ${swapCount}`;

        // DOM에서 실제 조각 위치 교환
        if (piece1.nextElementSibling === piece2) {
            puzzle.insertBefore(piece2, piece1);
        } else if (piece2.nextElementSibling === piece1) {
            puzzle.insertBefore(piece1, piece2);
        } else {
            const afterPiece2 = piece2.nextElementSibling;
            puzzle.insertBefore(piece2, piece1);
            if (afterPiece2) {
                puzzle.insertBefore(piece1, afterPiece2);
            } else {
                puzzle.appendChild(piece1);
            }
        }
    }

    function checkCompletion() {
        const isComplete = pieces.every(piece => piece.dataset.index === piece.dataset.currentIndex);
        if (isComplete) {
            document.getElementById('message').textContent = '퍼즐을 성공적으로 완성하셨습니다!';
            clearInterval(timerId)
            puzzle.style.backgroundImage = `url('${imagePath}')`;
            puzzle.style.backgroundSize = 'cover';  // 이미지가 요소를 꽉 채우도록 설정
            puzzle.innerHTML = '';
        }
    }


    function resetTimer() {
        clearInterval(timerId);
        totalTime = 120;
        timerId = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        let minutes = Math.floor(totalTime / 60);
        let seconds = totalTime % 60;
        seconds = seconds < 10 ? '0' + seconds : seconds;
        document.getElementById('timer').textContent = `Time left: ${minutes}:${seconds}`;
        totalTime--;
        if (totalTime < 0) {
            clearInterval(timerId);
            document.getElementById('message').textContent = '실패 하였습니다';
            puzzle.innerHTML = ''; // Optionally clear the puzzle
            puzzle.style.backgroundImage = '';
        }
    }



    initializePuzzle(); // Initialize on load
</script>
</body>
</html>
